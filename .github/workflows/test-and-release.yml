# Copyright 2025 Snowflake Inc.
# SPDX-License-Identifier: Apache-2.0
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Test and Release

on:
  pull_request:
    paths:
      - 'mcp_server_snowflake/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test-and-release.yml'
  push:
    branches:
      - main
    paths:
      - 'mcp_server_snowflake/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test-and-release.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5
        with:
          enable-cache: true
      - run: uv sync --all-extras --dev
      # TODO: enable once pyright passes
      # - run: uv run pyright
      - run: uv run pytest

  semantic-release-dry-run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5
        with:
          enable-cache: true
      - run: uv pip install --system python-semantic-release==10.4.1
      - run: semantic-release --noop -v version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: "github.event_name == 'push' && github.ref == 'refs/heads/main' && !startsWith(github.event.head_commit.message, 'chore(release): snowflake-labs-mcp')"
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5
        with:
          enable-cache: true
      - run: uv pip install --system python-semantic-release==10.4.1
      - name: Create release branch and version bump
        id: release
        run: |
          set -e

          # Store the current commit to detect if semantic-release makes changes
          BEFORE_COMMIT=$(git rev-parse HEAD)

          # Create a release branch (reuse same branch name to avoid orphaned branches)
          BRANCH_NAME="snowflake-labs-mcp/release-auto"
          git checkout -b "$BRANCH_NAME"

          # Force-push the branch to set up upstream tracking
          git push -f -u origin "$BRANCH_NAME"

          # Run semantic-release to bump version (it will create a commit if needed)
          # Don't create tag here since squash-merging orphans the tag
          semantic-release -v version --no-tag

          # Check if semantic-release created a new commit
          AFTER_COMMIT=$(git rev-parse HEAD)
          if [ "$BEFORE_COMMIT" = "$AFTER_COMMIT" ]; then
            echo "No version changes needed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

            # Push the branch (force push to update if branch already exists)
            git push -f origin "$BRANCH_NAME"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Pull Request
        if: steps.release.outputs.has_changes == 'true'
        run: |
          gh pr create \
            --title "chore(snowflake-labs-mcp): release version" \
            --body "Automated version bump by semantic-release" \
            --base main \
            --head "${{ steps.release.outputs.branch }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: "github.event_name == 'push' && github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'chore(release): snowflake-labs-mcp')"
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5
        with:
          enable-cache: true
      - name: Get version and create tag
        id: version
        run: |
          # Get version from pyproject.toml using Python
          pip install tomli
          VERSION=$(python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])")
          TAG="v${VERSION}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

          # Create and push tag
          git tag "$TAG"
          git push origin "$TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build wheel
        run: uv build --wheel
      - name: Publish to pyx registry
        run: uv publish --publish-url https://api.pyx.dev/v1/upload/notion/main
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYX_TOKEN }}
      - name: Create GitHub Release
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "snowflake-labs-mcp v${{ steps.version.outputs.version }}" \
            --generate-notes \
            dist/snowflake_labs_mcp-${{ steps.version.outputs.version }}-py3-none-any.whl
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
